version: '3.8'

services:
  # MongoDB Database 3.6
  mongodb:
    image: mongo:3.6
    container_name: parse-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: dev
    volumes:
      - mongodb_data:/data/db
    networks:
      - parse-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis (للـ Live Query)
  redis:
    image: redis:7-alpine
    container_name: parse-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - parse-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Parse Server
  parse-server:
    build: .
    container_name: parse-server
    ports:
      - "1337:1337"
    environment:
      NODE_ENV: production
      PORT: 1337
      HOST: 0.0.0.0
      
      # Application Keys
      APP_ID: myAppId
      MASTER_KEY: myMasterKey
      CLIENT_KEY: myClientKey
      FILE_KEY: myFileKey
      REST_API_KEY: myRestApiKey
      JAVA_KEY: myJavaKey
      
      # Database - MongoDB 3.6
      DATABASE_URI: mongodb://mongodb:27017/dev
      
      # Server URL
      SERVER_URL: http://localhost:1337/parse
      
      # Cloud Code
      CLOUD_MAIN: ./cloud/main.js
      
      # Dashboard
      DASHBOARD_USER: admin
      DASHBOARD_PASS: admin123
      
      # Redis
      REDIS_URL: redis://redis:6379
      
      # Logging
      LOG_LEVEL: info
    
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    volumes:
      - ./cloud:/app/cloud
      - ./logs:/app/logs
    
    networks:
      - parse-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1337/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local

networks:
  parse-network:
    driver: bridge
